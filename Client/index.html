<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/phaser-ce/2.10.3/phaser.min.js"></script>
</head>
<body>
<script>
var game = new Phaser.Game(768, 768, Phaser.AUTO, '', { preload: preload, create: create, update: update });

function preload() {
    game.load.image('gold', './assets/Gold.png');
    game.load.image('ground', './assets/background.png');
    game.load.image('myhero', './assets/Tuskan-Marine.png');
}

var player;
var cursors;

var turn = true;
var second = 10;
var myId;
var posPlayer1X;
var posPlayer1Y;
var posPlayer2X;
var posPlayer2Y;

TurnEndTimer = setInterval(fTurnEnd, 10000);

function fTurnEnd () {
    turn = false;
    labelTurn.setText(turn === true ? 'Ваш ход' : 'Ход соперника');
    second = 10;
}

function getRandomInt(max) {
  return Math.floor(Math.random() * Math.floor(max));
}

let secondsTimer = setInterval(seconds, 1000);

function seconds() {
    if (second === 1) {
        clearTimeout(secondsTimer);
        //secondsTimer.delete();
    }
    second = second - 1;
    timer.setText(second);
    /*if (second === 0) {
        second = 11;
    }*/
}
var pos;



function isGameReadyTimer () {
	
    var xhttp = new XMLHttpRequest();
    
    xhttp.onreadystatechange = function() {
        if (this.readyState == 4 && this.status == 200) {
			response = this.responseText;
			if (response.indexOf('game')>0) {
				clearTimeout(isGameReadyTimer);
			}
			console.log('response is '+response);
			pos = JSON.parse(response);
			console.log('pos is '+pos);
			
       }
    };
    xhttp.open("GET", "http://10.34.32.34:80/getStartGame?id="+myId, true);
    xhttp.send();

}

function position() {
    if (pos = 1)
    {
        posPlayer1X = 0;
        posPlayer1Y = 70;
        posPlayer2X = 630;
        posPlayer2Y = 630;
    }
    else if (pos = 2)
    {
        posPlayer1X = 630;
        posPlayer1Y = 630;
        posPlayer2X = 0;
        posPlayer2Y = 70;
    }
}

function create() {
    game.physics.startSystem(Phaser.Physics.ARCADE);

    game.add.sprite(0, 0, 'ground');

    game.world.setBounds(0, 0, 768, 768);//may be it will not work because of #23
    player = game.add.sprite(posPlayer1X, posPlayer1Y, 'myhero');
    player2 = game.add.sprite(posPlayer2X, posPlayer2Y, 'myhero');
    player.scale.setTo(0.5,0.5);
    player2.scale.setTo(0.5,0.5);
    timer = game.add.text(380, 20, second);
    labelTurn = game.add.text(450, 20, turn === true ? 'Ваш ход' : 'Ход соперника');
    game.add.sprite(660, 0, 'gold');

    game.physics.arcade.enable(player);
    cursors = game.input.keyboard.createCursorKeys();

    this.spaceKey = game.input.keyboard.addKey(Phaser.Keyboard.SPACEBAR);
    game.input.keyboard.addKeyCapture([ Phaser.Keyboard.ESC, Phaser.Keyboard.SPACEBAR ]);
    
    var xhttpGetId = new XMLHttpRequest();
    xhttpGetId.onreadystatechange = function() {
        if (this.readyState == 4 && this.status == 200) {
            myId = this.responseText;
       }
    };
    xhttpGetId.open("GET", "http://10.34.32.34:80/getId", true);
    xhttpGetId.send();
    isGameReadyTimerObj = setInterval(isGameReadyTimer, 5000);
}

function update() {
    
    function moveTo(x, y, player) {
        player.x = x;
        player.y = y;
        turn = false;
    }
    player.body.velocity.x = 0;
    player.body.velocity.y = 0;

	if (turn === true) {
		if (cursors.up.isDown)
		{
			moveTo(player.x,player.y-32,player);
		}
		else if (cursors.down.isDown)
		{
			moveTo(player.x,player.y+32,player);
		}
		if (cursors.left.isDown)
		{
			moveTo(player.x-32,player.y,player);
		}
		else if (cursors.right.isDown)
		{
			moveTo(player.x+32,player.y,player);
		}
		 
		if (this.spaceKey.isDown)
		{
			turn = false;
		}
	}
}
function endGame() { 
	localStorage.removeItem('playerId');
}
</script>
</body>
</html>
